-- Programa RIR023 (grabar en RIF003)
--===================================
SET SCHEMA LIBBHIRSCH;

INSERT INTO RIF003
SELECT 
CAST ((SELECT TRIM(CHAR(2000+CT.CNTPDY))||TRIM(CHAR(LPAD(CT.CNTPDM,2,'0')))||TRIM(CHAR(LPAD(CT.CNTPDD,2,'0'))) FROM CNTRLCNT CT WHERE CT.CNTKEY='01') AS VARCHAR(8)) AS FEC003,
CAST ((SELECT CHAR(T.COB000) FROM SBF000 T WHERE T.BNK000= D.DEABNK) AS VARCHAR(3)) AS BCO003,
'NA' AS CSU003, 
'0002' AS PRF003, 
(CASE WHEN D.DEAWHF='F' 
 THEN 
    CASE WHEN D.DEAICD< '1200' 
    THEN '01' 
    ELSE '02' 
    END 
 ELSE 
    'NA' 
 END) AS AFE003,
COALESCE((CASE WHEN SUBSTRING(D.DEAICD,1,1) = '1' OR SUBSTRING(D.DEAICD,1,2) = '22' 
 THEN '001' 
 ELSE
	CASE WHEN SUBSTRING(D.DEAICD,1,2) = '21' 
   THEN '002'  
	ELSE 
        CASE WHEN SUBSTRING(D.DEAICD,1,2) = '23' 
        THEN '003' ELSE '003'
        END 
    END
 END),'') AS TCR003, 
--  Algunos valores son 24: en ese caso se asigna vacio. El programa no lo considera sin embargo asigna '003'
(CASE WHEN D.DEAGLN = 1112001000000000 OR D.DEAGLN = 1112002000000000 
THEN '04' 
ELSE '01' 
END ) AS FCR003, 
(CASE WHEN SUBSTRING(D.DEARRC,1,1) = ''  
THEN '01' 
ELSE
    CASE WHEN SUBSTRING(D.DEARRC,1,1) = '2' 
    THEN '02' 
    ELSE 
        CASE WHEN SUBSTRING(D.DEARRC,1,1) = '3' 
        THEN '03' 
        ELSE 
            CASE WHEN SUBSTRING(D.DEARRC,1,1) = '4' 
            THEN '04' 
            ELSE  
                CASE WHEN SUBSTRING(D.DEARRC,1,1) = '5' 
                THEN '05' 
                ELSE '01' 
                END 
            END 
         END 
     END 
END) AS CLP003, 
(CASE WHEN SUBSTRING(C.CUSGEC,1,2) = 'PA' 
THEN 'L' 
ELSE 'E' 
END) AS FLE003, 
COALESCE(CAST((SELECT TRIM(A.COS301) FROM SBF301 A WHERE A.COD301= C.CUSGEC) AS VARCHAR(3)),'') AS GCD003,
(CASE WHEN C.CUSTID IN ('RUC','NIT','PAS') 
THEN C.CUSLN3 
ELSE 
    CASE WHEN C.CUSTID = 'CED'
    THEN 
        CASE WHEN C.CUSTID = 'CEO' THEN C.CUSIDF ELSE C.CUSLN3 END
    ELSE ''
    END 
END) AS IDN003, 
'' AS TEM003, 
(CASE WHEN C.CUSSEX = 'M' 
THEN '01' 
ELSE 
    CASE WHEN C.CUSSEX = 'F' 
    THEN '02' 
    ELSE 'NA' 
    END 
END) AS GEN003, 
(CASE WHEN D.DEAGLN = 1110508000000000 
THEN 'TC' 
ELSE CAST(D.DEAACC AS VARCHAR(12))
END) AS AC1003, 
CAST(C.CUSNA1 AS VARCHAR(30)) AS NOM003, 
(CASE WHEN C.CUSTYP IN ('M','R') 
THEN 
     C.CUSIDN 
ELSE 
     CASE WHEN C.CUSTYP = 'G' 
     THEN 
         CASE WHEN (SELECT COUNT(*) FROM CUMST CC WHERE CC.CUSCUN= C.CUSGRP) >0 
         THEN 
             (SELECT CC.CUSIDN FROM CUMST CC WHERE CC.CUSCUN= C.CUSGRP)
         ELSE 
             '' 
         END 
     ELSE
     	''
     END
END) AS GEC003, 
C.CUSUC6 AS TRE003, 
D.DEAICD AS TAC003, 
CAST(D.DEAFRT+D.DEARTE AS DECIMAL(9,6)) AS RAT003, 
D.DEAOAM AS MOR003,
D.DEAMEI AS IPC003, 
CAST(TRIM(CHAR(2000+D.DEAODY))||TRIM(CHAR(LPAD(D.DEAODM,2,'0')))||TRIM(CHAR(LPAD(D.DEAODD,2,'0'))) AS VARCHAR(8)) AS FEI003,
CAST(TRIM(CHAR(2000+D.DEAMAY))||TRIM(CHAR(LPAD(D.DEAMAM,2,'0')))||TRIM(CHAR(LPAD(D.DEAMAD,2,'0'))) AS VARCHAR(8)) AS FEV003, 
'NA' AS FER003, 
'NA' AS FEG003, 
'NA' AS ACA003, 
'NA' AS TG1003, 
0 AS MG1003, 
'NA' AS TG2003, 
0 AS MG2003,
'NA' AS TG3003, 
0 AS MG3003, 
'NA' AS TG4003, 
0 AS MG4003, 
'NA' AS TG5003, 
0 AS MG5003, 
0 AS PRO003, 
0 AS PNI003, 
0 AS PCO003, 
D.DEAPRI AS SAL003,
0 AS CVE003, 0 AS V30003, 0 AS V60003, 0 AS V90003, 
0 AS V12003, 0 AS V18003, 0 AS V1A003, 0 AS V51003, 
0 AS V10003, 0 AS VM1003, 0 AS CNE003, 0 AS N30003, 
0 AS N60003, 0 AS N90003, 0 AS N12003, 0 AS N18003,
0 AS N1A003, 0 AS NM1003,
(CASE WHEN C.CUSTYP IN ('M','R') 
THEN C.CUSNA1	 
ELSE 
    CASE WHEN C.CUSTYP IN ('G') 
    THEN 
        C.CUSNA1 
    ELSE 
        '' 
    END 
END) AS NGE003, 
'' AS FPC003,
'' AS PPC003, 
'' AS FPI003, 
'' AS PPI003, 
0 AS DIM003, 
'' AS PVE003, 
0 AS MCP003, 
D.DEABNK AS BNK003, 
D.DEABRN AS BRA003, 
D.DEACCY AS CCY003, 
D.DEAGLN AS CTA003,
D.DEAACC AS ACC003, 
D.DEACUN AS CUN003, 
D.DEATYP AS TYP003, 
D.DEAPRO AS PRD003, 
(CASE WHEN (SELECT COUNT(*) FROM SBF003K X WHERE X.ACT03K= D.DEAICD) >0 
THEN
    (SELECT X.TAC03K FROM SBF003K X WHERE X.ACT03K= D.DEAICD) 
ELSE 
    '' 
END) AS ACT003, 
(CASE WHEN (SELECT COUNT(*) FROM SBF003K X WHERE X.ACT03K= D.DEAICD) >0 
THEN
    (SELECT X.TPR03K FROM SBF003K X WHERE X.ACT03K= D.DEAICD) 
ELSE '' 
END) AS TPR003, 
(CASE WHEN D.DEAFTB = '' 
	THEN 
		(CASE WHEN D.DEARRP='' AND DEARRD=0 THEN 'F' ELSE 'V' END)
	ELSE
	'V'
END) AS FFV003, 
CAST(TRIM(CHAR(2000+D.DEARRY))||TRIM(CHAR(LPAD(D.DEARRM,2,'0')))||TRIM(CHAR(LPAD(D.DEARRD,2,'0'))) AS VARCHAR(8)) AS FCT003,
CAST((CASE WHEN 
DAYS(CAST(TRIM(CHAR(2000+D.DEAMAY))||'-'||TRIM(CHAR(LPAD(D.DEAMAM,2,'0')))||'-'||TRIM(CHAR(LPAD(D.DEAMAD,2,'0'))) AS DATE))- 
DAYS((SELECT CAST(TRIM(CHAR(2000+CT.CNTPDY))||'-'||TRIM(CHAR(LPAD(CT.CNTPDM,2,'0')))||'-'||TRIM(CHAR(LPAD(CT.CNTPDD,2,'0')))  AS DATE) FROM CNTRLCNT CT WHERE CT.CNTKEY='01')) < 0 
THEN 
	0 
ELSE 
DAYS(CAST(TRIM(CHAR(2000+D.DEAMAY))||'-'||TRIM(CHAR(LPAD(D.DEAMAM,2,'0')))||'-'||TRIM(CHAR(LPAD(D.DEAMAD,2,'0'))) AS DATE))- 
DAYS((SELECT CAST(TRIM(CHAR(2000+CT.CNTPDY))||'-'||TRIM(CHAR(LPAD(CT.CNTPDM,2,'0')))||'-'||TRIM(CHAR(LPAD(CT.CNTPDD,2,'0')))  AS DATE) FROM CNTRLCNT CT WHERE CT.CNTKEY='01')) 
END) AS DECIMAL(5,0)) AS DIA003, 
(CASE WHEN SUBSTRING(D.DEARRC,1,1) =' ' OR SUBSTRING(D.DEARRC,1,1) ='1'  
THEN 'A' 
ELSE
    CASE WHEN SUBSTRING(D.DEARRC,1,1) ='2' 
    THEN 'B' 
    ELSE 
        CASE WHEN SUBSTRING(D.DEARRC,1,1) ='3' 
        THEN 'C' 
        ELSE 
            CASE WHEN SUBSTRING(D.DEARRC,1,1) ='4' 
            THEN 'D' 
            ELSE  
                CASE WHEN SUBSTRING(D.DEARRC,1,1) ='5' 
                THEN 'E' 
                ELSE 
                    '' 
                END 
            END 
         END 
    END 
END) AS CAL003, 
COALESCE((SELECT 
    (CASE WHEN Z.SPF53B = 'NR' 
	THEN 
		(CASE WHEN Z.MOO53B='NR' THEN FIT53B ELSE Z.MOO53B END) 
	ELSE
		Z.SPF53B
	END) FROM SBF530B Z WHERE Z.GCD53B=  
	(SELECT 
            (CASE WHEN A.COS301<'012' 
            THEN 
                '591' 
            ELSE 
                A.COS301 
            END) FROM SBF301 A WHERE A.COD301= C.CUSGEC)),'') AS CRP003,  
0 AS NIV003, 
CAST(D.DEABNK||D.DEAGLN||D.DEABRN||D.DEACCY AS VARCHAR(24)) AS KEY003, 
CAST(SUBSTRING(D.DEAGLN,1,3) AS VARCHAR(3)) AS COR003, 
'S' AS FSN003, 
'' AS NCL003, '' AS NNO003, 
'' AS NFC003, '' AS NTC003, 
'' AS NGC003, '' AS NTA003, 
'' AS OFC003, 0 AS INM003, 
0 AS IND003, '' AS CPR003, 
'' AS PRE003, '' AS FUP003, 
0 AS DVI003, 0 AS DVC003, 
0 AS PRC003, 0 AS PRI003, 
0 AS CPA003, 0 AS DPV003, 
0 AS APV003, 0 AS DVE003, 
0 AS PGA003, 0 AS DSC003, 
0 AS SRI003, 
'' AS PUC003, 
CAST(TRIM(CHAR(2000+C.CUSIDY))||TRIM(CHAR(LPAD(C.CUSIDM,2,'0')))||TRIM(CHAR(LPAD(C.CUSIDD,2,'0'))) AS VARCHAR(8)) AS CRE003,
0 AS INT003, 0 AS AMO003, 
C.CUSUC1 AS COD003, 
CAST((COALESCE((SELECT T.DES53C FROM SBF530C T WHERE T.COD53C=C.CUSUC1), '')) AS VARCHAR(40)) AS NSC003
FROM DEALS D 
INNER JOIN CUMST C ON C.CUSCUN = D.DEACUN
WHERE 
D.DEABNK = '01' AND
D.DEASTS <>'C' AND 
D.DEATYP IN ('LNS','PAUT') AND 
D.DEAPRI > 0 AND 
SUBSTRING(D.DEAGLN,1,3) NOT IN (102,120,215,515,525);


--Archivos que se usan en la consulta
CNTRLCNT
SBF000
SBF301
SBF530B
SBF530C
SBF003K
DEALS
CUMST

--archivo donde graba 
RIF003